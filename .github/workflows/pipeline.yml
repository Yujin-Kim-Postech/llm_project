name: Build literature tree

on:
  push:
    paths:
      - "data/**"
      - "labels/paper_labels.jsonl"
      - "ontology.yaml"
      - "src/**"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run semi-auto labeling (review_queue)
        run: |
          python -m src.review_queue

      - name: Commit reviewed labels into paper_labels (auto-only)
        run: |
          python -m src.commit_labels

      - name: Build tree.json
        run: |
          python -m src.build_tree

      - name: Create/Update issue for items needing human review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import json, os, subprocess, textwrap
          from pathlib import Path

          rq = Path("labels/review_queue.jsonl")
          if not rq.exists():
              print("No review_queue.jsonl found")
              raise SystemExit(0)

          need = []
          for line in rq.read_text(encoding="utf-8").splitlines():
              if not line.strip():
                  continue
              obj = json.loads(line)
              if not (obj.get("final_l1") or "").strip():
                  need.append(obj)

          title = "Literature Tree: Human review needed"
          if not need:
              body = "✅ No items need human review. (All final_l1 are filled by semi-auto policy.)"
          else:
              lines = []
              lines.append(f"⚠️ {len(need)} papers need human labeling (final_l1/final_l2).")
              lines.append("")
              for o in need[:50]:
                  lines.append(f"- {o.get('paper_id')} — {o.get('title')}")
                  lines.append(f"  - l1_top3: {o.get('l1_top3')}")
              if len(need) > 50:
                  lines.append("")
                  lines.append(f"... and {len(need)-50} more.")
              lines.append("")
              lines.append("How to fix:")
              lines.append("1) Edit labels/paper_labels.jsonl (or fill final_* in labels/review_queue.jsonl locally)")
              lines.append("2) Push changes → workflow will rebuild tree.json")
              body = "\n".join(lines)

          # Find existing issue
          cmd = ["gh","issue","list","--search",f'in:title "{title}"',"--json","number,title","--limit","5"]
          res = subprocess.check_output(cmd, text=True)
          issues = json.loads(res)
          if issues:
              num = issues[0]["number"]
              subprocess.check_call(["gh","issue","edit",str(num),"--title",title,"--body",body])
              print(f"Updated issue #{num}")
          else:
              subprocess.check_call(["gh","issue","create","--title",title,"--body",body])
              print("Created issue")
          PY

      - name: Commit updated artifacts (tree + labels)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add labels/review_queue.jsonl labels/paper_labels.jsonl tree.json || true
          git commit -m "Update review queue, labels, and tree" || echo "No changes to commit"
          git push